input {
  beats {
    port => 5044
  }
}

filter {
  # 공통된 부분 파싱
  grok {
      match => {
      "message" => "\[%{TIMESTAMP_ISO8601:log_timestamp}\]\[%{NOTSPACE:thread_name}\] %{WORD} %{NOTSPACE} - \[%{WORD:log_type}\] %{WORD:http_method} %{NOTSPACE:api_path} \| %{GREEDYDATA:log_data}"
    }
  }
    
  if [api_path] =~ "admin" {
    mutate { add_field => { "role" => "admin" } }
  } else {
    mutate { add_field => { "role" => "user" } }
  }
  
  # log_type 값에 따라 다른 필터를 적용합니다.
  if [log_type] == "REQUEST" {
    grok {
      match => { "log_data" => "Args: %{GREEDYDATA:request_body}" }
    }
  } else if [log_type] == "RESPONSE" {
    grok {
      match => { "log_data" => "Return Value: %{GREEDYDATA:response_body} \| Time taken: %{NUMBER:time_taken:int}ms" }
    }
  } else if [log_type] == "ERROR" {
    grok {
      match => { "log_data" => "Exception: %{GREEDYDATA:exception_message} \| Time taken: %{NUMBER:time_taken:int}ms" }
    }
  }

  # 날짜 형식 파싱
  date {
    match => ["log_timestamp", "yyyy-MM-dd HH:mm:ss"]
    target => "@timestamp"
    timezone => "Asia/Seoul"
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "pdnight-aop-logs-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "elastic"
    ecs_compatibility => disabled

  }
}
